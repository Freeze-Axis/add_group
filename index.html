<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#a9ceec" />

  <title>Freeze グループスパムツール</title>
  <meta name="description" content="Discordで活動する多目的グループ“Freeze”の公式サイトです。" />

  <link rel="icon" href="https://i.ibb.co/LyFxxY5/freeze.png" />

  <!-- Open Graph -->
  <meta property="og:type"        content="website" />
  <meta property="og:site_name"   content="Freeze" />
  <meta property="og:title"       content="DMグループツール" />
  <meta property="og:description" content="やる側" />
  <meta property="og:url"         content="" />
  <meta property="og:image"       content="" />

  <!-- Google Font + ネオモーフィック＋ダークモードCSS -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

    body {
      margin: 0;
      padding: 30px 20px;
      background: linear-gradient(145deg, #1e1e2f, #2c2c3d);
      font-family: 'Roboto', sans-serif;
      color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 {
      font-size: 2.8em;
      margin-bottom: 30px;
      color: #4fc3f7;
      text-align: center;
      text-shadow: 1px 1px 4px #000;
    }
    /* --- UI/UX 改善 --- */
    .card {
      background: rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 28px 24px 24px 24px;
      margin-bottom: 28px;
      width: 100%;
      max-width: 900px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      border: 1.5px solid rgba(255,255,255,0.10);
      transition: transform 0.25s, box-shadow 0.25s;
      position: relative;
    }
    .card:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 12px 32px rgba(0,0,0,0.45);
    }
    .card h2 {
      color: #4fc3f7;
      margin-top: 0;
      margin-bottom: 18px;
      font-size: 1.5em;
      letter-spacing: 0.03em;
    }
    label {
      display: block;
      margin-top: 18px;
      font-weight: 500;
      color: #b3e5fc;
      font-size: 1.08em;
      letter-spacing: 0.01em;
    }
    input[type="text"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: 13px 15px;
      margin-top: 7px;
      border-radius: 9px;
      border: 1.5px solid #333a;
      background-color: #23233a;
      color: #fff;
      font-size: 1.08em;
      transition: border 0.3s, box-shadow 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    input:focus, textarea:focus {
      outline: none;
      border: 1.5px solid #4fc3f7;
      box-shadow: 0 0 0 2px #4fc3f755;
    }
    textarea { resize: vertical; min-height: 90px; }

    .inline {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 18px;
    }
    button {
      background: linear-gradient(90deg, #4fc3f7 60%, #29b6f6 100%);
      color: #0a0a0a;
      border: none;
      padding: 13px 22px;
      border-radius: 9px;
      font-size: 1.08em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.22);
      transition: background 0.25s, transform 0.18s;
      letter-spacing: 0.01em;
    }
    button:hover {
      background: linear-gradient(90deg, #29b6f6 60%, #4fc3f7 100%);
      transform: scale(1.04);
    }
    button:disabled {
      background: #444a;
      color: #aaa;
      cursor: not-allowed;
      box-shadow: none;
    }

    #toggleTokenBtn {
      background: #23233a;
      color: #b3e5fc;
      border: 1.5px solid #4fc3f7;
      padding: 10px 14px;
      border-radius: 7px;
      font-size: 1em;
      margin-left: 8px;
      transition: background 0.2s, color 0.2s;
    }
    #toggleTokenBtn:hover {
      background: #4fc3f7;
      color: #23233a;
    }

    #logArea {
      background: #181828;
      color: #00ff5a;
      padding: 20px 18px;
      border-radius: 10px;
      font-family: 'Roboto Mono', monospace;
      font-size: 1em;
      height: 260px;
      overflow-y: auto;
      white-space: pre-wrap;
      border: 1.5px solid #4fc3f7;
      margin-top: 10px;
      transition: border 0.3s;
    }
    #logArea::-webkit-scrollbar {
      width: 8px;
      background: #23233a;
    }
    #logArea::-webkit-scrollbar-thumb {
      background: #4fc3f7;
      border-radius: 4px;
    }

    /* --- カスタムアイコン関連 --- */
    .inline-icon {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
    }
    .custom-file-upload {
      display: inline-block;
      padding: 8px 14px;
      background: #4fc3f7;
      color: #0a0a0a;
      border-radius: 7px;
      cursor: pointer;
      font-weight: 500;
      margin-right: 8px;
      transition: background 0.2s;
    }
    .custom-file-upload:hover { background: #29b6f6; }
    .custom-file-upload input[type="file"] { display: none; }
    #iconPreview {
      display: none;
      max-width: 90px;
      max-height: 90px;
      border-radius: 8px;
      border: 1.5px solid #4fc3f7;
      margin-left: 8px;
    }
    #clearIconBtn {
      padding: 8px 14px;
      background: #ff5252;
      color: #fff;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      display: none;
      margin-left: 8px;
      transition: background 0.2s;
    }
    #clearIconBtn:hover { background: #ff1744; }

    /* スライドトグル */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
      vertical-align: middle;
    }
    .switch input { display: none; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #444;
      transition: .3s;
      border-radius: 12px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px; width: 18px;
      left: 3px; bottom: 3px;
      background-color: #ccc;
      transition: .3s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #4fc3f7;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .toggle-label {
      margin-left: 10px;
      font-weight: 500;
      color: #b3e5fc;
    }
    /* レスポンシブ */
    @media (max-width: 700px) {
      .card { padding: 16px 6px; }
      .logArea { font-size: 0.95em; }
      h1 { font-size: 2em; }
    }
    @media (max-width: 500px) {
      .card { padding: 8px 2px; }
      h1 { font-size: 1.3em; }
      .button-group { flex-direction: column; gap: 8px; }
    }
  </style>
</head>
<body>
  <h1>DMグループツール</h1>

  <!-- 1. 基本設定 -->
  <div class="card" id="basicSettings">
    <h2>基本設定</h2>

    <label for="token">BOT トークン:</label>
    <div class="inline">
      <input type="password" id="token" placeholder="Botトークンを入力">
      <button type="button" id="toggleTokenBtn">表示</button>
    </div>

    <label for="userIds">ユーザーID（改行区切り）:</label>
    <textarea id="userIds" placeholder="例：123456789012345678"></textarea>

    <label for="groupNames">グループ名（改行区切り）:</label>
    <textarea id="groupNames" placeholder="例：Group A"></textarea>

    <label for="iconImage">アイコン画像:</label>
    <div class="inline-icon">
      <label class="custom-file-upload">
        ファイルを選択
        <input type="file" id="iconImage" accept="image/*">
      </label>
      <button type="button" id="clearIconBtn">アイコン削除</button>
      <img id="iconPreview" alt="アイコンプレビュー">
    </div>
  </div>

  <!-- 2. グループ追加＆作成 -->
  <div class="card" id="groupOps">
    <h2>グループ追加＆作成</h2>

    <div class="button-group">
      <button type="button" id="createGroupBtn">グループ作成開始</button>
      <button type="button" id="stopCreateGroupBtn" disabled>作成停止</button>
    </div>
    <div class="inline" style="margin-top:8px">
      <label class="switch">
        <input type="checkbox" id="sendOnCreateToggle">
        <span class="slider"></span>
      </label>
      <span class="toggle-label">グループ作成時にメッセージ送信</span>
    </div>

    <div class="button-group" style="margin-top:15px">
      <button type="button" id="addGroupBtn">グループ追加開始</button>
      <button type="button" id="stopAddGroupBtn" disabled>追加停止</button>
    </div>
    <div class="inline" style="margin-top:8px">
      <label class="switch">
        <input type="checkbox" id="sendOnAddToggle">
        <span class="slider"></span>
      </label>
      <span class="toggle-label">グループ追加時にメッセージ送信</span>
    </div>
  </div>

  <!-- 3. メッセージ送信 -->
  <div class="card" id="messageSend">
    <h2>メッセージ送信</h2>
    <label for="sendMessage">送信メッセージ:</label>
    <textarea id="sendMessage" placeholder="全DMグループに送るメッセージを入力"></textarea>
    <div class="inline" style="margin-top:10px;align-items:center;gap:18px;">
      <label for="sendInterval" style="margin:0;">送信間隔(ms):</label>
      <input type="number" id="sendInterval" min="0" max="10000" step="100" value="200" style="width:100px;">
      <button type="button" id="sendMessageBtn">メッセージ一括送信</button>
      <button type="button" id="stopSendMessageBtn" disabled>送信停止</button>
    </div>
  </div>

  <!-- 処理ログ -->
  <div class="card">
    <h2>処理ログ</h2>
    <div id="logArea">ログがここに表示されます</div>
  </div>

  <!-- axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
  // --- Utility ---
  const cancelFlag = { add: false, create: false, send: false };
  function updateLog(msg, isError = false) {
    const area = document.getElementById('logArea');
    area.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    area.scrollTop = area.scrollHeight;
  }

  // キャンセル可能なsleep
  async function sleep(ms, cancelCheck) {
    const interval = 50;
    let elapsed = 0;
    while (elapsed < ms) {
      if (cancelCheck && cancelCheck()) throw new Error('キャンセルされました');
      await new Promise(r => setTimeout(r, Math.min(interval, ms - elapsed)));
      elapsed += interval;
    }
  }

  // 共通API呼び出し（レート制御・即時停止対応）
  async function safeApiCall(fn, cancelCheck, ...args) {
    while (true) {
      if (cancelCheck && cancelCheck()) throw new Error('キャンセルされました');
      try {
        const result = await fn(...args);
        if (cancelCheck && cancelCheck()) throw new Error('キャンセルされました');
        return result;
      } catch (e) {
        if (cancelCheck && cancelCheck()) throw new Error('キャンセルされました');
        const s = e.response?.status;
        if (s === 429) {
          const wait = e.response.data.retry_after || 1;
          updateLog(`レート制限：${wait}s 待機`, true);
          await sleep(wait * 1000, cancelCheck);
        } else if ([500, 504].includes(s)) {
          const w = s === 500 ? 30 : 10;
          updateLog(`サーバー${s}エラー：${w}s 待機`, true);
          await sleep(w * 1000, cancelCheck);
        } else {
          throw e;
        }
      }
    }
  }

  // --- Storage Utility ---
  const STORAGE_KEYS = {
    token: 'dmtool_token',
    userIds: 'dmtool_userIds',
    groupNames: 'dmtool_groupNames',
    sendMessage: 'dmtool_sendMessage',
    iconImage: 'dmtool_iconImage',
    sendOnCreate: 'dmtool_sendOnCreate',
    sendOnAdd: 'dmtool_sendOnAdd'
  };
  function saveToStorage(key, value) {
    try { localStorage.setItem(key, value); }
    catch (e) { /* ignore */ }
  }
  function loadFromStorage(key) {
    return localStorage.getItem(key) || '';
  }

  // --- Icon Preview ---
  function updateIconPreview() {
    const b64 = loadFromStorage(STORAGE_KEYS.iconImage);
    const img = document.getElementById('iconPreview');
    const btn = document.getElementById('clearIconBtn');
    if (b64) {
      img.src = b64.startsWith('data:') ? b64 : 'data:image/png;base64,' + b64;
      img.style.display = 'block';
      btn.style.display = 'inline-block';
    } else {
      img.removeAttribute('src');
      img.style.display = 'none';
      btn.style.display = 'none';
    }
  }

  // --- Restore on Load ---
  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('token').value       = loadFromStorage(STORAGE_KEYS.token);
    document.getElementById('userIds').value     = loadFromStorage(STORAGE_KEYS.userIds);
    document.getElementById('groupNames').value  = loadFromStorage(STORAGE_KEYS.groupNames);
    document.getElementById('sendMessage').value = loadFromStorage(STORAGE_KEYS.sendMessage);
    updateIconPreview();
    document.getElementById('sendOnCreateToggle').checked =
      localStorage.getItem(STORAGE_KEYS.sendOnCreate) === 'true';
    document.getElementById('sendOnAddToggle').checked =
      localStorage.getItem(STORAGE_KEYS.sendOnAdd) === 'true';
  });

  // --- Input Save ---
  document.getElementById('token').addEventListener('input', e =>
    saveToStorage(STORAGE_KEYS.token, e.target.value.trim())
  );
  document.getElementById('userIds').addEventListener('input', e =>
    saveToStorage(STORAGE_KEYS.userIds, e.target.value)
  );
  document.getElementById('groupNames').addEventListener('input', e =>
    saveToStorage(STORAGE_KEYS.groupNames, e.target.value)
  );
  document.getElementById('sendMessage').addEventListener('input', e =>
    saveToStorage(STORAGE_KEYS.sendMessage, e.target.value)
  );

  // --- Icon Upload ---
  document.getElementById('iconImage').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) {
      localStorage.removeItem(STORAGE_KEYS.iconImage);
      updateIconPreview();
      return;
    }
    const fr = new FileReader();
    fr.onload = () => {
      const dataUrl = fr.result;
      const b64 = dataUrl.split(',')[1];
      saveToStorage(STORAGE_KEYS.iconImage, b64);
      updateIconPreview();
    };
    fr.readAsDataURL(file);
  });

  // --- Toggle Save ---
  document.getElementById('sendOnCreateToggle').addEventListener('change', e => {
    localStorage.setItem(STORAGE_KEYS.sendOnCreate, e.target.checked);
  });
  document.getElementById('sendOnAddToggle').addEventListener('change', e => {
    localStorage.setItem(STORAGE_KEYS.sendOnAdd, e.target.checked);
  });

  // --- Icon Clear ---
  document.getElementById('clearIconBtn').addEventListener('click', () => {
    localStorage.removeItem(STORAGE_KEYS.iconImage);
    document.getElementById('iconImage').value = '';
    updateIconPreview();
    updateLog('アイコンを削除しました');
  });

  // --- Token Show/Hide ---
  document.getElementById('toggleTokenBtn').addEventListener('click', function() {
    const t = document.getElementById('token');
    t.type = t.type === 'password' ? 'text' : 'password';
    this.textContent = t.type === 'password' ? '表示' : '非表示';
  });

  // --- Group Create ---
  document.getElementById('createGroupBtn').onclick = async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) return updateLog('TOKENが必要です', true);
    const names = document.getElementById('groupNames').value
      .split('\n').map(l=>l.trim()).filter(l=>l) || ['Default'];
    const iconB64 = loadFromStorage(STORAGE_KEYS.iconImage);
    const sendOnCreate = document.getElementById('sendOnCreateToggle').checked;
    const msgTemplate = document.getElementById('sendMessage').value.trim();

    cancelFlag.create = false;
    document.getElementById('createGroupBtn').disabled = true;
    document.getElementById('stopCreateGroupBtn').disabled = false;
    updateLog('グループ作成開始');

    try {
      while (!cancelFlag.create) {
        for (let i = 0; i < 10 && !cancelFlag.create; i++) {
          try {
            const res = await safeApiCall(
              axios.post, () => cancelFlag.create,
              'https://discord.com/api/v9/users/@me/channels',
              { recipients: [] },
              { headers: { Authorization: token, 'Content-Type': 'application/json' } }
            );
            const cid = res.data.id;
            updateLog(`作成: チャネル ${cid}`);

            await safeApiCall(
              axios.patch, () => cancelFlag.create,
              `https://discord.com/api/v9/channels/${cid}`,
              {
                name: names[Math.floor(Math.random()*names.length)],
                icon: iconB64 ? `data:image/png;base64,${iconB64}` : null
              },
              { headers: { Authorization: token, 'Content-Type': 'application/json' } }
            );
            updateLog(`設定完了: ${cid}`);
            await sleep(0, () => cancelFlag.create); // ← 0ms遅延（アイコン・名前変更）

            if (sendOnCreate && msgTemplate) {
              await safeApiCall(
                axios.post, () => cancelFlag.create,
                `https://discord.com/api/v9/channels/${cid}/messages`,
                { content: msgTemplate },
                { headers: { Authorization: token, 'Content-Type': 'application/json' } }
              );
              updateLog(`作成直後送信: ${cid}`);
              await sleep(0, () => cancelFlag.create);
            }
          } catch (e) {
            if (e.message === 'キャンセルされました') break;
            updateLog(`作成失敗：${e.message}`, true);
          }
          await sleep(0, () => cancelFlag.create);
        }
        if (!cancelFlag.create) {
          updateLog('10件完了。10分待機');
          try { await sleep(10 * 60 * 1000, () => cancelFlag.create); } catch { break; }
        }
      }
    } finally {
      updateLog('グループ作成停止');
      document.getElementById('createGroupBtn').disabled = false;
      document.getElementById('stopCreateGroupBtn').disabled = true;
    }
  };
  document.getElementById('stopCreateGroupBtn').onclick = () => { cancelFlag.create = true; };

  // --- Group Add ---
  document.getElementById('addGroupBtn').onclick = async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) return updateLog('TOKENが必要です', true);
    let uids = document.getElementById('userIds').value
      .split('\n').map(l=>l.trim()).filter(l=>l);
    if (!uids.length) return updateLog('ユーザーIDが必要です', true);
    const names = document.getElementById('groupNames').value
      .split('\n').map(l=>l.trim()).filter(l=>l) || ['Default'];
    const iconB64 = loadFromStorage(STORAGE_KEYS.iconImage);
    const sendOnAdd = document.getElementById('sendOnAddToggle').checked;
    const msgTemplate = document.getElementById('sendMessage').value.trim();

    cancelFlag.add = false;
    document.getElementById('addGroupBtn').disabled = true;
    document.getElementById('stopAddGroupBtn').disabled = false;
    updateLog('グループ追加開始');

    try {
      while (!cancelFlag.add) {
        try {
          const res = await safeApiCall(
            axios.get, () => cancelFlag.add,
            'https://discord.com/api/v9/users/@me/channels',
            { headers: { Authorization: token } }
          );
          const dms = res.data.filter(c => c.type === 3);
          const remain = dms.filter(g => !g.recipients.some(r => uids.includes(r.id)));
          updateLog(`未参加グループ数：${remain.length}`);

          for (let g of remain.slice(0, 10)) {
            await safeApiCall(
              axios.patch, () => cancelFlag.add,
              `https://discord.com/api/v9/channels/${g.id}`,
              {
                name: names[Math.floor(Math.random()*names.length)],
                icon: iconB64 ? `data:image/png;base64,${iconB64}` : null
              },
              { headers: { Authorization: token, 'Content-Type': 'application/json' } }
            );
            await sleep(0, () => cancelFlag.add);

            const uid = uids[Math.floor(Math.random()*uids.length)];
            try {
              await safeApiCall(
                axios.put, () => cancelFlag.add,
                `https://discord.com/api/v9/channels/${g.id}/recipients/${uid}`,
                {},
                { headers: { Authorization: token } }
              );
            } catch (e) {
              // 404/10013: 不明なユーザー または 403/50007: DM不可
              if (
                (e.response && e.response.status === 404 && e.response.data?.code === 10013) ||
                (e.response && e.response.status === 403 && e.response.data?.code === 50007)
              ) {
                let reason = e.response.data?.code === 10013 ? '不明なユーザー' : 'DM不可ユーザー';
                updateLog(`ID ${uid} は${reason}のためID一覧から除外し、追加処理を停止します`, true);
                // ID一覧から除外
                uids = uids.filter(id => id !== uid);
                document.getElementById('userIds').value = uids.join('\n');
                saveToStorage(STORAGE_KEYS.userIds, uids.join('\n'));
                cancelFlag.add = true;
                break;
              } else {
                throw e;
              }
            }
            updateLog(`追加完了：${g.id}`);

            if (sendOnAdd && msgTemplate) {
              await safeApiCall(
                axios.post, () => cancelFlag.add,
                `https://discord.com/api/v9/channels/${g.id}/messages`,
                { content: msgTemplate },
                { headers: { Authorization: token, 'Content-Type': 'application/json' } }
              );
              updateLog(`追加直後送信: ${g.id}`);
              await sleep(0, () => cancelFlag.add);
            }
            await sleep(0, () => cancelFlag.add);
            if (cancelFlag.add) break;
          }
        } catch (e) {
          if (e.message === 'キャンセルされました') break;
          updateLog(`追加失敗：${e.message}`, true);
        }
        if (!cancelFlag.add) {
          updateLog('2分待機');
          try { await sleep(2 * 60 * 1000, () => cancelFlag.add); } catch { break; }
        }
      }
    } finally {
      updateLog('グループ追加停止');
      document.getElementById('addGroupBtn').disabled = false;
      document.getElementById('stopAddGroupBtn').disabled = true;
    }
  };
  document.getElementById('stopAddGroupBtn').onclick = () => { cancelFlag.add = true; };

  // --- Bulk Message Send ---
  document.getElementById('sendMessageBtn').onclick = async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) return updateLog('TOKENが必要です', true);
    const msg = document.getElementById('sendMessage').value.trim();
    if (!msg) return updateLog('メッセージを入力してください', true);
    const interval = parseInt(document.getElementById('sendInterval').value, 10) || 200;

    cancelFlag.send = false;
    document.getElementById('sendMessageBtn').disabled = true;
    document.getElementById('stopSendMessageBtn').disabled = false;
    updateLog('メッセージ送信開始');
    let stopped = false;
    try {
      const res = await safeApiCall(
        axios.get, () => cancelFlag.send,
        'https://discord.com/api/v9/users/@me/channels',
        { headers: { Authorization: token } }
      );
      const dms = res.data.filter(c => c.type === 3);
      for (let g of dms) {
        await safeApiCall(
          axios.post, () => cancelFlag.send,
          `https://discord.com/api/v9/channels/${g.id}/messages`,
          { content: msg },
          { headers: { Authorization: token, 'Content-Type': 'application/json' } }
        );
        updateLog(`送信：${g.id}`);
        await sleep(interval, () => cancelFlag.send);
        if (cancelFlag.send) { stopped = true; break; }
      }
    } catch (e) {
      if (e.message === 'キャンセルされました') stopped = true;
      else updateLog(`送信中エラー：${e.message}`, true);
    }
    updateLog(stopped ? 'メッセージ送信停止' : 'メッセージ送信完了');
    document.getElementById('sendMessageBtn').disabled = false;
    document.getElementById('stopSendMessageBtn').disabled = true;
  };
  document.getElementById('stopSendMessageBtn').onclick = () => { cancelFlag.send = true; };

  // --- UI/UX 改善 ---
  // ログエリアのクリアボタン
  if (!document.getElementById('clearLogBtn2')) {
    const clearBtn = document.createElement('button');
    clearBtn.id = 'clearLogBtn2';
    clearBtn.textContent = 'ログクリア';
    clearBtn.style.margin = '10px 0 0 0';
    clearBtn.style.background = '#23233a';
    clearBtn.style.color = '#4fc3f7';
    clearBtn.style.border = '1.5px solid #4fc3f7';
    clearBtn.style.borderRadius = '7px';
    clearBtn.style.padding = '8px 18px';
    clearBtn.style.fontSize = '1em';
    clearBtn.style.cursor = 'pointer';
    clearBtn.onclick = () => {
      document.getElementById('logArea').textContent = '';
    };
    document.getElementById('logArea').parentNode.insertBefore(clearBtn, document.getElementById('logArea'));
  }
  // ログエリアクリックで全選択
  document.getElementById('logArea').addEventListener('click', function() {
    const range = document.createRange();
    range.selectNodeContents(this);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  });
  // フォーカス時に自動全選択
  document.getElementById('logArea').addEventListener('focus', function() {
    const range = document.createRange();
    range.selectNodeContents(this);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  });
  // 入力欄のEnterで次の欄に自動フォーカス
  Array.from(document.querySelectorAll('input,textarea')).forEach((el, idx, arr) => {
    el.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey && el.tagName !== 'TEXTAREA') {
        e.preventDefault();
        if (arr[idx+1]) arr[idx+1].focus();
      }
    });
  });
  // ボタンにローディング表示
  function setLoading(btn, loading) {
    if (loading) {
      btn.dataset.oldText = btn.textContent;
      btn.textContent = '処理中...';
      btn.disabled = true;
    } else {
      if (btn.dataset.oldText) btn.textContent = btn.dataset.oldText;
      btn.disabled = false;
    }
  }
  </script>
</body>
</html>
